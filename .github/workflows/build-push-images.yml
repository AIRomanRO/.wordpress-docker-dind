name: Build and Push Docker Images

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  check-and-build:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to detect changes
      
      - name: Get PR labels
        id: pr-labels
        run: |
          LABELS=$(echo '${{ toJson(github.event.pull_request.labels.*.name) }}' | jq -r '.[]')
          echo "Labels: $LABELS"
          
          # Check for build-images and push-images labels
          BUILD_ALL=false
          PUSH_ALL=false
          
          if echo "$LABELS" | grep -q "build-images"; then
            BUILD_ALL=true
          fi
          
          if echo "$LABELS" | grep -q "push-images"; then
            PUSH_ALL=true
          fi
          
          echo "build_all=$BUILD_ALL" >> $GITHUB_OUTPUT
          echo "push_all=$PUSH_ALL" >> $GITHUB_OUTPUT
          
          # Validate: push-images requires build-images
          if [ "$PUSH_ALL" = "true" ] && [ "$BUILD_ALL" = "false" ]; then
            echo "âŒ Error: 'push-images' label requires 'build-images' label"
            exit 1
          fi
      
      - name: Detect changed images
        id: detect-changes
        run: |
          # Get the list of changed files in the PR
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Initialize arrays for changed images
          CHANGED_IMAGES=""
          
          # Check each image directory for changes
          if echo "$CHANGED_FILES" | grep -q "images/MySQL/56/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES mysql-5.6.51"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/MySQL/57/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES mysql-5.7.44"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/MySQL/80/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES mysql-8.0.40"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/php/7.4/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES php-7.4.33"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/php/8.0/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES php-8.0.30"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/php/8.1/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES php-8.1.31"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/php/8.2/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES php-8.2.26"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/php/8.3/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES php-8.3.14"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/nginx/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES nginx-1.27.3"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/apache/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES apache-2.4.62"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/phpMyAdmin/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES phpmyadmin-5.2.3"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/mailCatcher/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES mailcatcher-0.10.0"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/redis/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES redis-7.4.1"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/redis-commander/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES redis-commander-0.8.1"
          fi
          if echo "$CHANGED_FILES" | grep -q "images/docker-dind-wp/"; then
            CHANGED_IMAGES="$CHANGED_IMAGES dind-27.0.3"
          fi
          
          # Remove leading/trailing spaces
          CHANGED_IMAGES=$(echo "$CHANGED_IMAGES" | xargs)
          
          echo "Changed images: $CHANGED_IMAGES"
          echo "changed_images=$CHANGED_IMAGES" >> $GITHUB_OUTPUT
          
          # Determine if we have any changes
          if [ -n "$CHANGED_IMAGES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Docker Buildx
        if: steps.pr-labels.outputs.build_all == 'true' || steps.detect-changes.outputs.has_changes == 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        if: steps.pr-labels.outputs.push_all == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      
      - name: Build and Push Images
        if: steps.pr-labels.outputs.build_all == 'true' || steps.detect-changes.outputs.has_changes == 'true'
        env:
          BUILD_ALL: ${{ steps.pr-labels.outputs.build_all }}
          PUSH_ALL: ${{ steps.pr-labels.outputs.push_all }}
          CHANGED_IMAGES: ${{ steps.detect-changes.outputs.changed_images }}
          DOCKER_HUB_REPO: airoman/wp-dind
        run: |
          set -e
          
          # Function to build an image
          build_image() {
            local context=$1
            local service_name=$2
            local version=$3
            local additional_tag=$4
            
            local local_image="${service_name}:${version}"
            local hub_tag="${service_name#wp-}-${version}"
            local hub_image="${DOCKER_HUB_REPO}:${hub_tag}"
            
            echo "ðŸ”¨ Building ${service_name}:${version}..."
            docker build -t "${local_image}" "$context"
            docker tag "${local_image}" "${hub_image}"
            
            if [ -n "$additional_tag" ]; then
              local local_tag="${service_name}:${additional_tag}"
              local hub_alias_tag="${service_name#wp-}-${additional_tag}"
              local hub_alias="${DOCKER_HUB_REPO}:${hub_alias_tag}"
              docker tag "${local_image}" "${local_tag}"
              docker tag "${local_image}" "${hub_alias}"
            fi
            
            echo "âœ… Built ${hub_image}"
            
            # Push if PUSH_ALL is true
            if [ "$PUSH_ALL" = "true" ]; then
              echo "ðŸ“¤ Pushing ${hub_image}..."
              docker push "${hub_image}"
              if [ -n "$additional_tag" ]; then
                local hub_alias_tag="${service_name#wp-}-${additional_tag}"
                docker push "${DOCKER_HUB_REPO}:${hub_alias_tag}"
              fi
              echo "âœ… Pushed ${hub_image}"
            fi
          }
          
          # Function to check if image should be built
          should_build() {
            local image_tag=$1
            
            if [ "$BUILD_ALL" = "true" ]; then
              return 0
            fi
            
            if echo "$CHANGED_IMAGES" | grep -q "$image_tag"; then
              return 0
            fi
            
            return 1
          }
          
          echo "========================================="
          echo "Building Docker Images"
          echo "========================================="
          echo "Build All: $BUILD_ALL"
          echo "Push All: $PUSH_ALL"
          echo "Changed Images: $CHANGED_IMAGES"
          echo "========================================="
          
          # Build MySQL images
          if should_build "mysql-5.6.51"; then
            build_image "./images/MySQL/56" "wp-mysql" "5.6.51" "5.6"
          fi
          if should_build "mysql-5.7.44"; then
            build_image "./images/MySQL/57" "wp-mysql" "5.7.44" "5.7"
          fi
          if should_build "mysql-8.0.40"; then
            build_image "./images/MySQL/80" "wp-mysql" "8.0.40" "8.0"
          fi
          
          # Build PHP images
          if should_build "php-7.4.33"; then
            build_image "./images/php/7.4" "wp-php" "7.4.33"
          fi
          if should_build "php-8.0.30"; then
            build_image "./images/php/8.0" "wp-php" "8.0.30"
          fi
          if should_build "php-8.1.31"; then
            build_image "./images/php/8.1" "wp-php" "8.1.31"
          fi
          if should_build "php-8.2.26"; then
            build_image "./images/php/8.2" "wp-php" "8.2.26"
          fi
          if should_build "php-8.3.14"; then
            build_image "./images/php/8.3" "wp-php" "8.3.14"
          fi
          
          # Build Nginx image
          if should_build "nginx-1.27.3"; then
            build_image "./images/nginx" "wp-nginx" "1.27.3"
          fi
          
          # Build Apache image
          if should_build "apache-2.4.62"; then
            build_image "./images/apache" "wp-apache" "2.4.62"
          fi
          
          # Build phpMyAdmin image
          if should_build "phpmyadmin-5.2.3"; then
            build_image "./images/phpMyAdmin" "wp-phpmyadmin" "5.2.3"
          fi
          
          # Build MailCatcher image
          if should_build "mailcatcher-0.10.0"; then
            build_image "./images/mailCatcher" "wp-mailcatcher" "0.10.0"
          fi
          
          # Build Redis image
          if should_build "redis-7.4.1"; then
            build_image "./images/redis" "wp-redis" "7.4.1" "7.4"
          fi
          
          # Build Redis Commander image
          if should_build "redis-commander-0.8.1"; then
            build_image "./images/redis-commander" "wp-redis-commander" "0.8.1"
          fi
          
          # Build Docker-in-Docker image
          if should_build "dind-27.0.3"; then
            build_image "./images/docker-dind-wp" "wp-dind" "27.0.3" "27.0"
          fi
          
          echo "========================================="
          echo "âœ… Build process completed!"
          echo "========================================="
      
      - name: Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build All**: ${{ steps.pr-labels.outputs.build_all }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Push All**: ${{ steps.pr-labels.outputs.push_all }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Images**: ${{ steps.detect-changes.outputs.changed_images }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.pr-labels.outputs.build_all }}" = "true" ]; then
            echo "âœ… All images were built" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.detect-changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… Changed images were built" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No images were built (no changes detected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.pr-labels.outputs.push_all }}" = "true" ]; then
            echo "âœ… Images were pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Images were not pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
          fi

